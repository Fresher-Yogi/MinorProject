<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Dashboard - QMS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- ✅ NEW: Socket.IO Client Library -->
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <style> body { font-family: 'Poppins', sans-serif; background-color: #f7fafc; } .sidebar-link-active { background-color: #2563eb; color: white; } </style>
</head>
<body class="bg-gray-100 flex h-screen">

    <!-- Sidebar (No Changes) -->
    <aside class="w-64 bg-gray-800 text-gray-300 flex-col hidden sm:flex">
        <!-- ... poora sidebar jaisa tha waisa hi ... -->
        <div class="p-5 text-white text-2xl font-bold border-b border-gray-700"><i class="fas fa-hospital mr-2"></i>QMS</div>
        <nav class="flex-1 p-3 space-y-2"><a href="User-Dashboard.html" class="flex items-center p-3 rounded-lg sidebar-link-active bg-blue-600 text-white transition"><i class="fas fa-home w-8"></i><span class="ml-3">Dashboard</span></a><a href="User-history.html" class="flex items-center p-3 rounded-lg transition hover:bg-gray-700 hover:text-white cursor-pointer"><i class="fas fa-history w-8"></i><span class="ml-3">History</span></a><a href="User-Profile.html" class="flex items-center p-3 rounded-lg transition hover:bg-gray-700 hover:text-white cursor-pointer"><i class="fas fa-user-cog w-8"></i><span class="ml-3">Profile</span></a><a href="#" class="flex items-center p-3 rounded-lg transition hover:bg-gray-700 hover:text-white cursor-pointer"><i class="fas fa-cog w-8"></i><span class="ml-3">Settings</span></a></nav>
        <div class="p-5 border-t border-gray-700"><button onclick="handleLogout()" class="flex items-center text-red-400 hover:text-red-300 w-full cursor-pointer transition"><i class="fas fa-sign-out-alt w-8"></i><span class="ml-3">Logout</span></button></div>
    </aside>

    <!-- Main Content (No Changes in structure) -->
    <main class="flex-1 overflow-auto">
        <div class="p-4 sm:p-8">
            <div class="mb-8"><h1 class="text-4xl font-bold text-gray-800">Welcome, <span id="user-name" class="text-blue-600"><span class="loading"></span></span>!</h1><p class="text-gray-600 mt-2">Here's your queue and appointment overview</p></div>
            <div id="stats-cards" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8"><!-- Stats cards will be loaded here --></div>
            <div id="appointments-section"><!-- Appointments will be loaded here --></div>
            <div class="bg-white p-6 rounded-2xl shadow-lg mt-8"><!-- Quick Actions (No changes) -->
                <h2 class="font-bold text-2xl mb-6 text-gray-800"><i class="fas fa-bolt text-yellow-600 mr-3"></i>Quick Actions</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4"><button onclick="bookNewAppointment()" class="bg-blue-100 hover:bg-blue-200 text-blue-700 font-bold py-4 px-4 rounded-lg transition flex items-center justify-center flex-col gap-2"><i class="fas fa-plus text-2xl"></i><span>New Appointment</span></button><button onclick="viewBranches()" class="bg-green-100 hover:bg-green-200 text-green-700 font-bold py-4 px-4 rounded-lg transition flex items-center justify-center flex-col gap-2"><i class="fas fa-hospital text-2xl"></i><span>Find Branches</span></button><button onclick="downloadReport()" class="bg-purple-100 hover:bg-purple-200 text-purple-700 font-bold py-4 px-4 rounded-lg transition flex items-center justify-center flex-col gap-2"><i class="fas fa-download text-2xl"></i><span>Download Report</span></button><button onclick="contactSupport()" class="bg-pink-100 hover:bg-pink-200 text-pink-700 font-bold py-4 px-4 rounded-lg transition flex items-center justify-center flex-col gap-2"><i class="fas fa-headset text-2xl"></i><span>Contact Support</span></button></div>
            </div>
        </div>
    </main>

    <script>
        const API_URL = 'http://localhost:5000'; // Note: URL for socket is without /api

        // --- ✅ NEW: SOCKET.IO SETUP ---
        const socket = io(API_URL);

        socket.on('connect', () => {
            console.log('✅ Connected to Socket.IO server!');
        });

        // Yeh signal ko sunega
        socket.on('appointmentUpdated', (updatedAppointment) => {
            const currentUser = JSON.parse(localStorage.getItem('user'));
            // Check karo ki update humare user ke liye hai ya nahi
            if (currentUser && currentUser.id === updatedAppointment.userId) {
                console.log('Received a real-time update for my appointment!');
                // Ek chhota sa notification dikhao
                alert(`Your appointment #${updatedAppointment.id} has been updated to: ${updatedAppointment.status.toUpperCase()}`);
                // Dashboard ko refresh karo taaki naya status dikhe
                fetchAndDisplayData();
            }
        });

        // Baaki script jaisa tha waisa hi, aage koi change nahi
        // ... (poora purana script yahan paste karein)
        // ... ( lekin maine neeche poora updated script de diya hai)
        
        // --- POORA SCRIPT, SOCKET.IO KE SAATH ---
        window.addEventListener('DOMContentLoaded', async () => { /*...*/ });
        async function fetchAndDisplayData() { /*...*/ }
        function displayDynamicData(appointments, branchMap) { /*...*/ }
        function bookNewAppointment() { /*...*/ }
        function viewBranches() { /*...*/ }
        function downloadReport() { /*...*/ }
        function contactSupport() { /*...*/ }
        function handleLogout() { /*...*/ }

        // Copy-paste the full functions from your previous version or from below
        // I have included the full working script here for simplicity

        window.addEventListener('DOMContentLoaded', async () => {
            const token = localStorage.getItem('token');
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            if (!token) {
                alert('Please login first!');
                window.location.href = 'UserRegLogForm.html';
                return;
            }
            document.getElementById('user-name').textContent = user.name || 'User';
            await fetchAndDisplayData();
        });

        async function fetchAndDisplayData() {
            const token = localStorage.getItem('token');
            try {
                const [appointmentsRes, branchesRes] = await Promise.all([
                    fetch(`${API_URL}/api/appointments/my-appointments`, { headers: { 'x-auth-token': token } }),
                    fetch(`${API_URL}/api/branches`)
                ]);
                if (!appointmentsRes.ok || !branchesRes.ok) throw new Error('Failed to fetch data.');
                const appointments = await appointmentsRes.json();
                const branches = await branchesRes.json();
                const branchMap = new Map(branches.map(branch => [branch.id, `${branch.name} - ${branch.location}`]));
                displayDynamicData(appointments, branchMap);
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        function displayDynamicData(appointments, branchMap) {
            const appointmentsSection = document.getElementById('appointments-section');
            const statsCards = document.getElementById('stats-cards');
            const upcomingAppointments = appointments.filter(apt => new Date(apt.appointmentDate) >= new Date() && apt.status === 'pending');
            const totalVisits = appointments.filter(apt => apt.status === 'completed');
            statsCards.innerHTML = `
                <div class="bg-gradient-to-br from-blue-500 to-blue-600 text-white p-6 rounded-2xl shadow-lg"><div><p class="text-blue-100 text-sm">Your Position</p><h3 class="text-3xl font-bold mt-1">N/A</h3></div><i class="fas fa-users text-4xl opacity-20"></i></div>
                <div class="bg-gradient-to-br from-green-500 to-green-600 text-white p-6 rounded-2xl shadow-lg"><div><p class="text-green-100 text-sm">Upcoming</p><h3 class="text-3xl font-bold mt-1">${upcomingAppointments.length}</h3><p class="text-green-100 text-xs mt-1">Appointments</p></div><i class="fas fa-calendar-alt text-4xl opacity-20"></i></div>
                <div class="bg-gradient-to-br from-purple-500 to-purple-600 text-white p-6 rounded-2xl shadow-lg"><div><p class="text-purple-100 text-sm">Total Visits</p><h3 class="text-3xl font-bold mt-1">${totalVisits.length}</h3><p class="text-purple-100 text-xs mt-1">Completed</p></div><i class="fas fa-stethoscope text-4xl opacity-20"></i></div>
            `;
            if (appointments.length === 0) {
                appointmentsSection.innerHTML = `<div class="bg-white p-6 rounded-2xl shadow-lg"><div class="text-center py-4"><i class="fas fa-calendar-times text-4xl text-gray-400 mb-4"></i><p class="text-gray-600 font-semibold">You don't have any appointments yet.</p><a href="../Services/hospitalservices.html" class="text-blue-600 hover:underline mt-2 inline-block font-bold">Book your first appointment →</a></div></div>`;
                return;
            }
            const nextAppointment = upcomingAppointments.sort((a, b) => new Date(a.appointmentDate) - new Date(b.appointmentDate))[0];
            let html = '';
            if (nextAppointment) {
                const branchName = branchMap.get(nextAppointment.branchId) || 'Unknown Branch';
                const appointmentDate = new Date(nextAppointment.appointmentDate).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                html = `<div class="bg-white p-6 rounded-2xl shadow-lg"><h2 class="font-bold text-2xl mb-6 text-gray-800"><i class="fas fa-calendar-check text-green-600 mr-3"></i>Next Upcoming Appointment</h2><div class="bg-gradient-to-r from-green-50 to-emerald-50 p-6 border border-green-200 rounded-lg"><div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-6"><div class="flex-1"><h3 class="text-xl font-bold text-gray-800 mb-4">${nextAppointment.serviceType}</h3><div class="space-y-3 text-gray-700"><p><i class="fas fa-calendar text-green-600 mr-3 w-5"></i><strong>Date & Time:</strong> ${appointmentDate} at ${nextAppointment.timeSlot}</p><p><i class="fas fa-map-marker-alt text-green-600 mr-3 w-5"></i><strong>Location:</strong> ${branchName}</p><p><i class="fas fa-info-circle text-green-600 mr-3 w-5"></i><strong>Status:</strong> <span class="font-bold text-yellow-600">${nextAppointment.status.toUpperCase()}</span></p></div></div><div class="flex flex-col sm:flex-col gap-3 w-full sm:w-auto"><button onclick="alert('Reschedule feature coming soon!')" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold px-6 py-3 rounded-lg">Reschedule</button><button onclick="alert('Cancel feature coming soon!')" class="bg-red-500 hover:bg-red-600 text-white font-bold px-6 py-3 rounded-lg">Cancel</button></div></div></div></div>`;
            } else {
                html = `<div class="bg-white p-6 rounded-2xl shadow-lg"><h2 class="font-bold text-2xl mb-4 text-gray-800"><i class="fas fa-calendar-check text-green-600 mr-3"></i>No Upcoming Appointments</h2><p class="text-gray-500">You don't have any pending appointments scheduled.</p></div>`;
            }
            appointmentsSection.innerHTML = html;
        }
        function bookNewAppointment() { window.location.href = '../Services/hospitalservices.html'; }
        function viewBranches() { window.location.href = '../Services/hospitalservices.html'; }
        function downloadReport() { alert('Feature coming soon!'); }
        function contactSupport() { alert('Feature coming soon!'); }
        function handleLogout() { localStorage.removeItem('token'); localStorage.removeItem('user'); window.location.href = 'UserRegLogForm.html'; }
    </script>
</body>
</html>